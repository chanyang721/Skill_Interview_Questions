> User 기관 테이블 설계

- BtoB를 진행하면서 특정 기관 혹은 학교와 계약을 진행하게 되어 특정 유저에게 권한을 주기 위해 관련 테이블을 만드는 과정을 경험하였다.
- 처음 생각은 Agency 테이블을 만들어 계약을 진행 할 기관들 정보를 하나의 테이블에서 관리하면서 Access Code를 발급해야겠다고 생각하였다. 그렇기 때문에 회원가입 도중에 Agency테이블에 쿼리를 날려서 Access Code를 입력하여 확인이 완료되면 해당 agency_key와 agency_type을 리턴하여 프론트 단계에서 해당 타입을 보고 입력 페이지를 설정하면 좋을 것 같다고 생각하게 되었다.
- 문제는 이 다음이었는데 어제 TIL을 작성한 것 처럼 User가 기업 회원인 경우와, 학교 회원인 경우 입력되는 정보가 다르기 때문에 각각 다른 테이블에 저장하게 된다. 여기서 어제는 User가 기업, 학교와 OneToMany관계라고 착각하였지만, OneToOne의 관계인 것이라고 생각되어 관계를 변경하였다. 하지만 문제는 FK키를 어느 테이블에 넣는지 였다.
- User 테이블에 기관 인증에 필요한 테이블 FK를 넣어서 Join시 혹은 eager: true를 이용하여 관련된 사항을 관계를 맺지 않고 가져오는 방법이 있었고, User 테이블에 agency_key 를 넣고 Agency 테이블에 기업, 학교 테이블에 OneToMany 관계를 가지게 하여 Join 쿼리를 하는 방법이 있었다.
- 결국 User와 기업, 학교 테이블 정보를 OneToOne관계로 두고, eager: true로 바로 딸려나오게 한하는 것이 더 조금 더 깔끔한 테이블 구조라고 생각하게 되었다. Agency테이블은 회원 가입 시 Access Code를 확인하는 용도로만 사용하고 Agency 테이블과 하위 테이블인 기업, 학교 테이블은 OneToMany관계로 agency_key로 연결하여 혹시 모를 인증 확인 용도로만 사용하려고 한다.

> DB 싱크 맞추기 위한 마이그레이션 진행

- 예전부터 벼르고 벼르던 DB 마이그레이션 및 로컬 환경과 싱크를 맞추는 작업을 더이상 미룰 수 없다고 생각되었다. 개발이 진행 될수록 나중에 부채가 쌓여가는 것을 느꼈고, 이 이상 싱크 맞추는 작업 없이 개발을 진행하면 감당할 수 없는 상태가 될 것이 너무 뻔히 보였기 때문이다.
- 우선 서비스 단계에 있는 DB의 structure and data dump 파일을 여러개 만들었다. 그 후, 로컬상에 있는 DB와 서비스 단계의 entity 순서와 타입, 그리고 세부 옵션을 하나씩 대조하면서 틀린 부분이 없는지 세번정도 확인한 뒤 로컬에 있는 DB와 싱크를 맞추어 entity들을 생성하였다.
- 그 후 서비스 단계에 있는 dump 데이터를 붙여넣고 잘 들어갔는지 확인하고 로컬에 있는 싱크를 맞추어 서비스 단계에 있는 데이터를 붙여넣은 DB를 dump를 만든다.
- 서비스 단계 DB에서 로컬에서 싱크를 맞춘 DB를 import한 뒤 ORM옵션에서 연결 DB를 수정하여 테스트 한다.
- 해당 과정을 진행하면서 어떻게 하면 기존의 DB를 보존한 상태로 손쉽게 DB의 싱크를 맞출 수 있을까에 대해 생각해보는 좋은 경험을 하였다고 생각되었다. 만약 다음에 마이그레이션을 진행 할 기회가 생긴다면 중간에 스크립트를 낑겨 넣어 데이터 마이그레이션도 해보고 싶다 !
